# Docker Compose for LOFT Autonomous Test Harness
#
# Usage:
#   # Start a 4-hour autonomous run
#   docker-compose -f docker-compose.autonomous.yml up
#
#   # Run with custom dataset and duration
#   DATASET_PATH=/datasets/torts DURATION=2h docker-compose -f docker-compose.autonomous.yml up
#
#   # Check status
#   curl http://localhost:8080/health

version: '3.8'

services:
  loft-autonomous:
    build:
      context: .
      dockerfile: Dockerfile.autonomous
    container_name: loft-autonomous

    # Environment variables
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL:-}
      - AUTONOMOUS_MAX_DURATION_HOURS=${DURATION_HOURS:-4}
      - AUTONOMOUS_CHECKPOINT_INTERVAL=${CHECKPOINT_INTERVAL:-15}
      - AUTONOMOUS_LLM_MODEL=${LLM_MODEL:-claude-3-5-haiku-20241022}
      - AUTONOMOUS_LOG_LEVEL=${LOG_LEVEL:-INFO}
      - AUTONOMOUS_HEALTH_PORT=8080

    # Volume mounts
    volumes:
      # Persist run data between container restarts
      - ./data/autonomous_runs:/data/autonomous_runs
      # Mount datasets directory
      - ./datasets:/datasets:ro
      # Optional: mount custom config
      - ./config:/app/config:ro

    # Port mapping for health checks
    ports:
      - "8080:8080"

    # Restart policy for long-running jobs
    restart: unless-stopped

    # Grace period for graceful shutdown (5 minutes)
    stop_grace_period: 5m

    # Resource limits (adjust based on available resources)
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

    # Default command: start autonomous run
    command:
      - start
      - --dataset
      - ${DATASET_PATH:-/datasets/contracts}
      - --duration
      - ${DURATION:-4h}
      - --output
      - /data/autonomous_runs
      - --health-port
      - "8080"

    # Health check configuration
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

# Named volumes for data persistence
volumes:
  autonomous_runs:
    driver: local
